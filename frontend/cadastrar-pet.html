<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Pet - Lar Doce Lar</title>
    <link rel="stylesheet" href="./css/style.css">
</head>

<body class="bg-primary">
    <!-- Header -->
    <header class="header">
        <div class="container header-content">
            <h1 class="logo-text">üêæ Lar Doce Lar</h1>
            <nav class="nav">
                <a href="dashboard.html" class="nav-link">Pets</a>
                <a href="perfil.html" class="nav-link">Meu Perfil</a>
                <button onclick="handleLogout()" class="btn btn-secondary btn-sm">Sair</button>
            </nav>
        </div>
    </header>

    <div class="container">
        <div class="form-container">
            <div class="form-header">
                <button onclick="window.location.href='dashboard.html'" class="btn btn-ghost">
                    ‚Üê Voltar
                </button>
                <h2 id="form-title">Cadastrar Novo Pet</h2>
            </div>

            <form id="pet-form" onsubmit="handleSubmit(event)">
                <!-- Upload de Imagem -->
                <div class="form-group">
                    <label>Foto do Pet</label>
                    <div class="image-upload-area">
                        <div id="image-preview" class="image-preview hidden">
                            <img id="preview-img" src="" alt="Preview">
                            <button type="button" class="btn-remove-image" onclick="removeImage()">‚úï</button>
                        </div>
                        <label id="upload-label" for="image-input" class="upload-label">
                            <div class="upload-placeholder">
                                <span class="upload-icon">üì∑</span>
                                <p>Clique para enviar</p>
                                <p class="upload-hint">PNG, JPG at√© 5MB</p>
                            </div>
                            <input type="file" id="image-input" accept="image/*" onchange="handleImageUpload(event)"
                                hidden>
                        </label>
                    </div>
                </div>

                <!-- Nome -->
                <div class="form-group">
                    <label for="nome">Nome do Pet *</label>
                    <input type="text" id="nome" required placeholder="Ex: Rex, Mia, Bob...">
                </div>

                <!-- Esp√©cie -->
                <div class="form-group">
                    <label for="especie">Esp√©cie *</label>
                    <input type="text" id="especie" required placeholder="Ex: Cachorro, Gato, Coelho...">
                </div>

                <!-- Ra√ßa -->
                <div class="form-group">
                    <label for="raca">Ra√ßa</label>
                    <input type="text" id="raca" placeholder="Ex: Vira-lata, Siam√™s, SRD...">
                </div>

                <!-- Idade -->
                <div class="form-group">
                    <label for="idade">Idade *</label>
                    <input type="text" id="idade" required placeholder="Ex: 2 anos, 6 meses, Filhote...">
                </div>

                <!-- Descri√ß√£o -->
                <div class="form-group">
                    <label for="descricao">Hist√≥ria/Descri√ß√£o</label>
                    <textarea id="descricao" rows="5"
                        placeholder="Conte a hist√≥ria deste pet, personalidade, cuidados especiais..."></textarea>
                </div>

                <!-- Status (apenas para edi√ß√£o) -->
                <div id="status-group" class="form-group hidden">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="disponivel">Dispon√≠vel</option>
                        <option value="em_processo">Em processo de ado√ß√£o</option>
                        <option value="adotado">Adotado</option>
                    </select>
                </div>

                <!-- Bot√µes -->
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        üíæ Cadastrar Pet
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast hidden"></div>

    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script>
        let petId = null;
        let uploadedImagePath = null;

        // Verificar se √© edi√ß√£o
        window.addEventListener('DOMContentLoaded', async () => {
            // Verificar autentica√ß√£o
            if (!checkAuth()) {
                window.location.href = 'index.html';
                return;
            }

            // Verificar se √© abrigo
            const user = await getProfile();
            if (user.tipo !== 'abrigo') {
                showToast('Apenas abrigos podem cadastrar pets', 'error');
                setTimeout(() => window.location.href = 'dashboard.html', 2000);
                return;
            }

            // Verificar se √© edi√ß√£o
            const urlParams = new URLSearchParams(window.location.search);
            petId = urlParams.get('id');

            if (petId) {
                document.getElementById('form-title').textContent = 'Editar Pet';
                document.getElementById('submit-btn').innerHTML = 'üíæ Salvar Altera√ß√µes';
                document.getElementById('status-group').classList.remove('hidden');
                await loadPet();
            }
        });

        // Carregar pet para edi√ß√£o
        async function loadPet() {
            try {
                const response = await fetch(`${API_URL}/pets/${petId}`);
                const pet = await response.json();

                document.getElementById('nome').value = pet.nome;
                document.getElementById('especie').value = pet.especie;
                document.getElementById('raca').value = pet.raca || '';
                document.getElementById('idade').value = pet.idade;
                document.getElementById('descricao').value = pet.descricao || '';
                document.getElementById('status').value = pet.status;

                if (pet.imagem) {
                    uploadedImagePath = pet.imagem;
                    showImagePreview(`${API_URL}${pet.imagem}`);
                }
            } catch (error) {
                showToast('Erro ao carregar pet', 'error');
                console.error('Erro:', error);
            }
        }

        // Upload de imagem
        async function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tamanho
            if (file.size > 5 * 1024 * 1024) {
                showToast('A imagem deve ter no m√°ximo 5MB', 'error');
                return;
            }

            // Preview local
            const reader = new FileReader();
            reader.onload = (e) => {
                showImagePreview(e.target.result);
            };
            reader.readAsDataURL(file);

            // Upload para servidor
            try {
                const formData = new FormData();
                formData.append('image', file);

                const token = localStorage.getItem('token');
                const response = await fetch(`${API_URL}/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) throw new Error('Erro no upload');

                const data = await response.json();
                uploadedImagePath = data.url;
                showToast('Imagem enviada com sucesso!', 'success');
            } catch (error) {
                showToast('Erro ao fazer upload da imagem', 'error');
                console.error('Erro:', error);
            }
        }

        // Mostrar preview
        function showImagePreview(src) {
            document.getElementById('preview-img').src = src;
            document.getElementById('image-preview').classList.remove('hidden');
            document.getElementById('upload-label').classList.add('hidden');
        }

        // Remover imagem
        function removeImage() {
            uploadedImagePath = null;
            document.getElementById('image-preview').classList.add('hidden');
            document.getElementById('upload-label').classList.remove('hidden');
            document.getElementById('image-input').value = '';
        }

        // Submeter formul√°rio
        async function handleSubmit(event) {
            event.preventDefault();

            const petData = {
                nome: document.getElementById('nome').value,
                especie: document.getElementById('especie').value,
                raca: document.getElementById('raca').value,
                idade: document.getElementById('idade').value,
                descricao: document.getElementById('descricao').value,
                imagem: uploadedImagePath || '',
                status: petId ? document.getElementById('status').value : 'disponivel'
            };

            try {
                const token = localStorage.getItem('token');
                const url = petId ? `${API_URL}/pets/${petId}` : `${API_URL}/pets`;
                const method = petId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(petData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao salvar pet');
                }

                showToast(petId ? 'Pet atualizado com sucesso!' : 'Pet cadastrado com sucesso!', 'success');
                setTimeout(() => window.location.href = 'perfil.html', 1500);
            } catch (error) {
                showToast(error.message, 'error');
                console.error('Erro:', error);
            }
        }
    </script>
</body>

</html>